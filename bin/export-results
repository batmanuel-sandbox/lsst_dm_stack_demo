#!/usr/bin/env python
import re
import sys
import numpy as np
import lsst.daf.persistence as dafPersist
from lsst.obs.sdss import SdssMapper
from lsst.afw.geom import Angle

if len(sys.argv) != 2:
    print >>sys.stderr, "Usage: export-results <output_directory>"
    exit(1);
outputdir = sys.argv[1]

# Load sources and print interesting columns

cols = ("id", 
        "coord.ra",
        "coord.dec",
        "flags.negative",
        "flags.badcentroid",
        "flags.pixel.edge",
        "flags.pixel.interpolated.any",
        "flags.pixel.interpolated.center",
        "flags.pixel.saturated.any",
        "flags.pixel.saturated.center",
        "centroid.sdss.x",
        "centroid.sdss.y",
        "centroid.sdss.err.xx",
        "centroid.sdss.err.yy",
        "shape.sdss.xx",
        "shape.sdss.xy",
        "shape.sdss.yy",
        "shape.sdss.err.xx",
        "shape.sdss.err.xy",
        "shape.sdss.err.yy",
        "shape.sdss.flags",
        "flux.gaussian",
        "flux.gaussian.err",
        "flux.psf",
        "flux.psf.err",
        "flux.sinc",
        "flux.sinc.err",
        "classification.extendedness",
        "correctfluxes.apcorr",
        "correctfluxes.apcorr.flags",
        )

print '#' + ' '.join(cols)

butler = dafPersist.Butler(outputdir)
for filter in "ugriz":
    for dataId in (dict(run=4192, filter=filter, field=300, camcol=4),
                   dict(run=6377, filter=filter, field=399, camcol=4),
                   ):
        if not butler.datasetExists("src", **dataId):
            continue

        srcs = butler.get("src", **dataId)

        vecs = []
        for col in cols:
            if col.endswith(".ra") or col.endswith(".dec"):
                v = np.rad2deg(srcs.get(col))
            elif re.search(r"\.err\.(xx|yy|xy)$", col):
                field, which = re.search(r"^(.*\.err)\.(xx|yy|xy)$", col).groups()
                key = srcs.schema.find(field).key
                key = key[0,0] if which == "xx" else key[1,1] if which == "yy" else key[0, 1]

                v = srcs.get(key)
            else:
                v = srcs.get(col)

            vecs.append(v)

        for vals in zip(*vecs):
            print ' '.join([str(el) for el in vals])
