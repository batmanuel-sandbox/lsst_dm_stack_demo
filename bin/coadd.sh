#!/bin/bash

type outlierRejectedCoadd.py >/dev/null 2>&1 || { echo "Could not find outlierRejectedCoadd.py on your path. Have you sourced loadLSST.sh, and setup-ed pipe_tasks?"; exit 1; }
eups list --setup obs_sdss >/dev/null 2>&1 || ( echo "obs_sdss does not appear to be setup, or eups is not configured correctly."; exit 1; )
test -d input || { echo "Could not find the 'input' directory. Run this script from the directory where the 'input' subdirectory resides."; exit 1; }
test -d output || { echo "Could not find the 'output' directory. Run demo.sh first, and then run this script from the directory where the 'output' subdirectory resides."; exit 1; }
set -e

echo -n "MySQL database name: "
read MYSQL_DB
echo -n "MySQL host: "
read MYSQL_HOST
echo -n "MySQL username: "
read MYSQL_USER

MYSQL_ARGS=""
if [ ! -f ~/.my.cnf ]; then
    MYSQLARGS="-u $MYSQL_USER -h $MYSQL_HOST -p"
    if [ ! -d ~/.lsst ]; then
    	mkdir ~/.lsst
    	chmod 700 ~/.lsst
    fi
    if [ ! -f ~/.lsst/db-auth.paf ]; then
        echo -n "MySQL password: "
        read -s MYSQL_PASS
    	cat > ~/.lsst/db-auth.paf <<EOF
database: {
    authInfo: {
        host: $MYSQL_HOST
        port: 3306
        user: $MYSQL_USER
        password: $MYSQL_PASS
    }
}
EOF
    	chmod 600 ~/.lsst/db-auth.paf
    fi
fi

mysql $MYSQLARGS <<EOF
CREATE DATABASE IF NOT EXISTS $MYSQL_DB;
CREATE TABLE IF NOT EXISTS ${MYSQL_DB}.SeasonFieldQuality_Test (
    time BIGINT,
    season INT,
    filter CHAR(1),
    run INT,
    rerun INT,
    camCol INT,
    field INT,
    ccdLoc INT,
    stripe INT,
    strip CHAR(1),
    eqnlScn INT,
    node DOUBLE,
    softBias INT,
    flux20 DOUBLE,
    fieldid BIGINT,
    nObjects INT,
    nGalaxy INT,
    nStars INT,
    quality INT,
    airmass FLOAT,
    sky FLOAT,
    psfWidth FLOAT,
    ra1 DOUBLE,
    dec1 DOUBLE,
    ra2 DOUBLE,
    dec2 DOUBLE,
    ra3 DOUBLE,
    dec3 DOUBLE,
    ra4 DOUBLE,
    dec4 DOUBLE,
    aveRa DOUBLE,
    aveDec DOUBLE,
    isblacklisted TINYINT(1),
    PRIMARY KEY (fieldid, filter)
    );
REPLACE INTO ${MYSQL_DB}.SeasonFieldQuality_Test VALUES
    (1066553301310,2003,'g',4192,40,4,300,54,82,'S',2000,95,1000,2703.57,8658188290289827840,993,537,303,3,1.18769,0.00000000218271,1.33718,-8.432999999999993,-0.008943,-8.269999999999982,-0.008953,-8.269999999999982,0.216343,-8.432999999999993,0.216353,-8.351499999999987,0.1037,0),
    (1066553086330,2003,'i',4192,40,4,300,24,82,'S',2000,95,1000,1591.25,8658188290289827840,993,537,303,3,1.1873,0.000000007935,1.14757,-8.432999999999993,-0.008927,-8.269000000000005,-0.008955,-8.269000000000005,0.216382,-8.432999999999993,0.21641,-8.350999999999999,0.1037275,0),
    (1066553014680,2003,'r',4192,40,4,300,14,82,'S',2000,95,1000,1981.78,8658188290289827840,993,537,303,3,1.18723,0.00000000467075,1.18173,-8.432000000000016,-0.009,-8.269000000000005,-0.008985,-8.267999999999972,0.216459,-8.432000000000016,0.216445,-8.350250000000003,0.10372975000000001,0),
    (1066553157990,2003,'u',4192,40,4,300,34,82,'S',2000,95,1000,958.696,8658188290289827840,993,537,303,3,1.1874,0.00000000152907,1.43622,-8.432999999999993,-0.009416,-8.269000000000005,-0.009384,-8.269000000000005,0.216089,-8.432999999999993,0.216056,-8.350999999999999,0.10333624999999999,0),
    (1066553229650,2003,'z',4192,40,4,300,44,82,'S',2000,95,1000,263.949,8658188290289827840,993,537,303,3,1.18753,0.0000000225973,1.21514,-8.432999999999993,-0.008874,-8.269000000000005,-0.008863,-8.269000000000005,0.216586,-8.432999999999993,0.216574,-8.350999999999999,0.10385575,0),
    (1158746482730,2006,'g',6377,40,4,399,54,82,'S',2000,95,1000,2673.77,8658197674799857664,1089,614,299,2,1.19972,0.00000000175626,1.31702,-8.437000000000012,-0.008548,-8.273000000000025,-0.008536,-8.273000000000025,0.216754,-8.437000000000012,0.216742,-8.355000000000018,0.104103,0),
    (1158746267780,2006,'i',6377,40,4,399,24,82,'S',2000,95,1000,1564.03,8658197674799857664,1089,614,299,2,1.20263,0.0000000070402,1.09812,-8.435999999999979,-0.008495,-8.273000000000025,-0.008524,-8.273000000000025,0.2168,-8.435999999999979,0.21683,-8.354500000000002,0.10415274999999999,0),
    (1158746196130,2006,'r',6377,40,4,399,14,82,'S',2000,95,1000,1948.81,8658197674799857664,1089,614,299,2,1.20367,0.00000000391169,1.09142,-8.435999999999979,-0.008556,-8.271999999999991,-0.008556,-8.271999999999991,0.216862,-8.435999999999979,0.216862,-8.353999999999985,0.104153,0),
    (1158746339430,2006,'u',6377,40,4,399,34,82,'S',2000,95,1000,871.385,8658197674799857664,1089,614,299,2,1.20163,0.00000000153608,1.27458,-8.437000000000012,-0.008923,-8.273000000000025,-0.00896,-8.273000000000025,0.216467,-8.437000000000012,0.216504,-8.355000000000018,0.103772,0),
    (1158746411080,2006,'z',6377,40,4,399,44,82,'S',2000,95,1000,262.599,8658197674799857664,1089,614,299,2,1.20065,0.0000000217133,1.24659,-8.437000000000012,-0.00847,-8.273000000000025,-0.008473,-8.273000000000025,0.216986,-8.437000000000012,0.216989,-8.355000000000018,0.104258,0);

CREATE TABLE IF NOT EXISTS ${MYSQL_DB}.SeasonFieldQuality_To_Htm10 (
    htmId10 INT,
    fieldid BIGINT,
    filter CHAR(1),
    PRIMARY KEY (htmId10, fieldid, filter)
);
REPLACE INTO ${MYSQL_DB}.SeasonFieldQuality_To_Htm10 VALUES
    (12065024,8658188290289827840,'g'),
    (12065026,8658188290289827840,'g'),
    (12065027,8658188290289827840,'g'),
    (12066048,8658188290289827840,'g'),
    (12592640,8658188290289827840,'g'),
    (12592641,8658188290289827840,'g'),
    (12592642,8658188290289827840,'g'),
    (12592643,8658188290289827840,'g'),
    (12594688,8658188290289827840,'g'),
    (12594689,8658188290289827840,'g'),
    (12594690,8658188290289827840,'g'),
    (12594691,8658188290289827840,'g'),
    (12594697,8658188290289827840,'g'),
    (12594701,8658188290289827840,'g'),
    (12594702,8658188290289827840,'g'),
    (12594703,8658188290289827840,'g'),
    (12065024,8658188290289827840,'i'),
    (12065026,8658188290289827840,'i'),
    (12065027,8658188290289827840,'i'),
    (12066048,8658188290289827840,'i'),
    (12592640,8658188290289827840,'i'),
    (12592641,8658188290289827840,'i'),
    (12592642,8658188290289827840,'i'),
    (12592643,8658188290289827840,'i'),
    (12594688,8658188290289827840,'i'),
    (12594689,8658188290289827840,'i'),
    (12594690,8658188290289827840,'i'),
    (12594691,8658188290289827840,'i'),
    (12594697,8658188290289827840,'i'),
    (12594701,8658188290289827840,'i'),
    (12594702,8658188290289827840,'i'),
    (12594703,8658188290289827840,'i'),
    (12065024,8658188290289827840,'r'),
    (12065026,8658188290289827840,'r'),
    (12065027,8658188290289827840,'r'),
    (12066048,8658188290289827840,'r'),
    (12592640,8658188290289827840,'r'),
    (12592641,8658188290289827840,'r'),
    (12592642,8658188290289827840,'r'),
    (12592643,8658188290289827840,'r'),
    (12594688,8658188290289827840,'r'),
    (12594689,8658188290289827840,'r'),
    (12594690,8658188290289827840,'r'),
    (12594691,8658188290289827840,'r'),
    (12594697,8658188290289827840,'r'),
    (12594701,8658188290289827840,'r'),
    (12594702,8658188290289827840,'r'),
    (12594703,8658188290289827840,'r'),
    (12065024,8658188290289827840,'u'),
    (12065026,8658188290289827840,'u'),
    (12065027,8658188290289827840,'u'),
    (12066048,8658188290289827840,'u'),
    (12592640,8658188290289827840,'u'),
    (12592641,8658188290289827840,'u'),
    (12592642,8658188290289827840,'u'),
    (12592643,8658188290289827840,'u'),
    (12594688,8658188290289827840,'u'),
    (12594689,8658188290289827840,'u'),
    (12594690,8658188290289827840,'u'),
    (12594691,8658188290289827840,'u'),
    (12594697,8658188290289827840,'u'),
    (12594701,8658188290289827840,'u'),
    (12594702,8658188290289827840,'u'),
    (12594703,8658188290289827840,'u'),
    (12065024,8658188290289827840,'z'),
    (12065026,8658188290289827840,'z'),
    (12065027,8658188290289827840,'z'),
    (12066048,8658188290289827840,'z'),
    (12592640,8658188290289827840,'z'),
    (12592641,8658188290289827840,'z'),
    (12592642,8658188290289827840,'z'),
    (12592643,8658188290289827840,'z'),
    (12594688,8658188290289827840,'z'),
    (12594689,8658188290289827840,'z'),
    (12594690,8658188290289827840,'z'),
    (12594691,8658188290289827840,'z'),
    (12594697,8658188290289827840,'z'),
    (12594701,8658188290289827840,'z'),
    (12594702,8658188290289827840,'z'),
    (12594703,8658188290289827840,'z'),
    (12065024,8658197674799857664,'g'),
    (12065026,8658197674799857664,'g'),
    (12065027,8658197674799857664,'g'),
    (12066048,8658197674799857664,'g'),
    (12592640,8658197674799857664,'g'),
    (12592641,8658197674799857664,'g'),
    (12592642,8658197674799857664,'g'),
    (12592643,8658197674799857664,'g'),
    (12594688,8658197674799857664,'g'),
    (12594689,8658197674799857664,'g'),
    (12594690,8658197674799857664,'g'),
    (12594691,8658197674799857664,'g'),
    (12594697,8658197674799857664,'g'),
    (12594701,8658197674799857664,'g'),
    (12594702,8658197674799857664,'g'),
    (12594703,8658197674799857664,'g'),
    (12065024,8658197674799857664,'i'),
    (12065026,8658197674799857664,'i'),
    (12065027,8658197674799857664,'i'),
    (12066048,8658197674799857664,'i'),
    (12592640,8658197674799857664,'i'),
    (12592641,8658197674799857664,'i'),
    (12592642,8658197674799857664,'i'),
    (12592643,8658197674799857664,'i'),
    (12594688,8658197674799857664,'i'),
    (12594689,8658197674799857664,'i'),
    (12594690,8658197674799857664,'i'),
    (12594691,8658197674799857664,'i'),
    (12594697,8658197674799857664,'i'),
    (12594701,8658197674799857664,'i'),
    (12594702,8658197674799857664,'i'),
    (12594703,8658197674799857664,'i'),
    (12065024,8658197674799857664,'r'),
    (12065026,8658197674799857664,'r'),
    (12065027,8658197674799857664,'r'),
    (12066048,8658197674799857664,'r'),
    (12592640,8658197674799857664,'r'),
    (12592641,8658197674799857664,'r'),
    (12592642,8658197674799857664,'r'),
    (12592643,8658197674799857664,'r'),
    (12594688,8658197674799857664,'r'),
    (12594689,8658197674799857664,'r'),
    (12594690,8658197674799857664,'r'),
    (12594691,8658197674799857664,'r'),
    (12594697,8658197674799857664,'r'),
    (12594701,8658197674799857664,'r'),
    (12594702,8658197674799857664,'r'),
    (12594703,8658197674799857664,'r'),
    (12065024,8658197674799857664,'u'),
    (12065026,8658197674799857664,'u'),
    (12065027,8658197674799857664,'u'),
    (12066048,8658197674799857664,'u'),
    (12592640,8658197674799857664,'u'),
    (12592641,8658197674799857664,'u'),
    (12592642,8658197674799857664,'u'),
    (12592643,8658197674799857664,'u'),
    (12594688,8658197674799857664,'u'),
    (12594689,8658197674799857664,'u'),
    (12594690,8658197674799857664,'u'),
    (12594691,8658197674799857664,'u'),
    (12594697,8658197674799857664,'u'),
    (12594701,8658197674799857664,'u'),
    (12594702,8658197674799857664,'u'),
    (12594703,8658197674799857664,'u'),
    (12065024,8658197674799857664,'z'),
    (12065026,8658197674799857664,'z'),
    (12065027,8658197674799857664,'z'),
    (12066048,8658197674799857664,'z'),
    (12592640,8658197674799857664,'z'),
    (12592641,8658197674799857664,'z'),
    (12592642,8658197674799857664,'z'),
    (12592643,8658197674799857664,'z'),
    (12594688,8658197674799857664,'z'),
    (12594689,8658197674799857664,'z'),
    (12594690,8658197674799857664,'z'),
    (12594691,8658197674799857664,'z'),
    (12594697,8658197674799857664,'z'),
    (12594701,8658197674799857664,'z'),
    (12594702,8658197674799857664,'z'),
    (12594703,8658197674799857664,'z');
EOF

rm -rf coadd coaddMeasure

makeSkyMap.py sdss output \
    --config coaddName=goodSeeing \
    --config skyMap.active.decRange=0.004062606377776751,0.20470260637777676 skyMap.active.patchInnerDimensions=512,2024 skyMap.active.tractOverlap=0.0110 \
    --output coadd
outlierRejectedCoadd.py sdss coadd \
    --id filter=u^g^r^i^z tract=3 patch=146,0 \
    --config coaddName=goodSeeing \
    --config desiredFwhm=None doInterp=False doSigmaClip=False \
    --config subregionSize=512,2024 \
    --config select.camcols=4,4 select.strip=S select.rejectWholeRuns=False \
    --config select.database=$MYSQL_DB select.host=$MYSQL_HOST
processCoadd.py sdss coadd \
    --id filter=u^g^r^i^z tract=3 patch=146,0 \
    --config coaddName=goodSeeing \
    --config calibrate.doBackground=False \
    --config calibrate.detection.reEstimateBackground=False \
    --output coaddMeasure
